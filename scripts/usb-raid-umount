#!/bin/bash
#
# RAID Management System
# Copyright (c) 2025 Beijing Tangta Technology Co., ltd
# 
# This software is licensed under the MIT License
# See LICENSE file for full license details
#
# Description: USB RAID Unmount Script - Multi-Array Support
# Version: 1.0
# Author: Tarik Aslan
#

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Default array number if none specified
ARRAY_NUMBER=${1:-0}
ARRAY_DEVICE="/dev/md${ARRAY_NUMBER}"
MOUNT_POINT="/mnt/usb-raid${ARRAY_NUMBER}"

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_usage() {
    echo "Usage: $0 [array-number]"
    echo ""
    echo "Examples:"
    echo "  $0           # Unmount /dev/md0 from /mnt/usb-raid0"
    echo "  $0 0         # Unmount /dev/md0 from /mnt/usb-raid0"
    echo "  $0 1         # Unmount /dev/md1 from /mnt/usb-raid1"
    echo ""
    echo "Currently mounted USB RAID arrays:"
    for dev in /dev/md*; do
        if [ -b "$dev" ]; then
            MOUNT_PT=$(findmnt -n -o TARGET "$dev" 2>/dev/null)
            if [ -n "$MOUNT_PT" ]; then
                echo "  $dev -> $MOUNT_PT"
            fi
        fi
    done
}

# Show help if requested
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    show_usage
    exit 0
fi

# Validate array number
if ! [[ "$ARRAY_NUMBER" =~ ^[0-9]+$ ]]; then
    error "Invalid array number: $1"
    echo "Array number must be a positive integer"
    show_usage
    exit 1
fi

main() {
    log "Attempting to unmount USB RAID array ${ARRAY_NUMBER}..."
    
    # Check if mount point exists and is mounted
    if [ ! -d "$MOUNT_POINT" ]; then
        warn "Mount point $MOUNT_POINT does not exist"
        exit 0
    fi

    if ! mountpoint -q "$MOUNT_POINT"; then
        warn "$MOUNT_POINT is not mounted"
        exit 0
    fi

    # Check what's actually mounted there
    MOUNTED_DEVICE=$(findmnt -n -o SOURCE "$MOUNT_POINT" 2>/dev/null)
    if [ "$MOUNTED_DEVICE" != "$ARRAY_DEVICE" ]; then
        warn "Mount point $MOUNT_POINT has different device: $MOUNTED_DEVICE"
        log "Proceeding with unmount anyway..."
    fi

    # Unmount the array
    log "Unmounting $MOUNT_POINT..."
    if sudo umount "$MOUNT_POINT"; then
        log "Successfully unmounted $MOUNT_POINT"
        
        # Optional: Remove mount point directory
        read -p "Remove mount point directory $MOUNT_POINT? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            sudo rmdir "$MOUNT_POINT"
            log "Mount point directory removed"
        fi
    else
        error "Failed to unmount $MOUNT_POINT"
        error "Possible reasons:"
        error "1. Filesystem is busy"
        error "2. Processes using the mount point"
        echo ""
        log "Check with: lsof +D $MOUNT_POINT"
        log "Or force unmount: sudo umount -f $MOUNT_POINT"
        exit 1
    fi
}

main "$@"
