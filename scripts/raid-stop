#!/bin/bash
#
# RAID Management System
# Copyright (c) 2025 Beijing Tangta Technology Co., ltd
# 
# This software is licensed under the MIT License
# See LICENSE file for full license details
#
# Description: RAID Stop Script for Partition-based RAID
# Version: 1.0
# Author: Tarik Aslan
#

set -e

# Configuration
ARRAY_NAME="/dev/md0"
MOUNT_POINT="/mnt/usb-raid"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Main execution
main() {
    log "Stopping partition-based RAID array..."
    
    # Check if array exists
    if [ ! -b "$ARRAY_NAME" ]; then
        warn "RAID array $ARRAY_NAME does not exist or is not assembled"
        return 0
    fi

    # Unmount if mounted
    if mountpoint -q "$MOUNT_POINT" 2>/dev/null; then
        log "Unmounting $MOUNT_POINT..."
        sudo umount "$MOUNT_POINT"
        log "Unmounted successfully"
    else
        warn "Mount point $MOUNT_POINT is not mounted or doesn't exist"
    fi

    # Stop the array
    log "Stopping RAID array $ARRAY_NAME..."
    if sudo mdadm --stop "$ARRAY_NAME"; then
        log "RAID array stopped successfully"
    else
        error "Failed to stop RAID array"
        return 1
    fi
}

main "$@"
