#!/bin/bash
#
# RAID Management System
# Copyright (c) 2025 Beijing Tangta Technology Co., ltd
# 
# This software is licensed under the MIT License
# See LICENSE file for full license details
#
# Description: RAID Resync Progress Monitor
# Version: 1.0
# Author: Tarik Aslan
#


ARRAY_NAME="/dev/md0"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

echo -e "${BLUE}=== RAID Resync Progress Monitor ===${NC}"
echo -e "${CYAN}Press Ctrl+C to stop monitoring${NC}"
echo ""

if [ ! -b "$ARRAY_NAME" ]; then
    echo -e "${RED}✗ RAID array not active${NC}"
    exit 1
fi

# Get current mdstat
MDSTAT=$(cat /proc/mdstat)

# Debug: Show what we're detecting
echo -e "${YELLOW}Debug: Checking for resync...${NC}"
echo "$MDSTAT" | grep -A2 "md0"

# Check if resync is active - use multiple detection methods
if echo "$MDSTAT" | grep -A2 "md0" | grep -q "resync"; then
    echo -e "${YELLOW}Resync detected - starting monitor...${NC}"
    echo ""
elif echo "$MDSTAT" | grep -A2 "md0" | grep -q "recovery"; then
    echo -e "${YELLOW}Recovery detected - starting monitor...${NC}"
    echo ""
else
    echo -e "${GREEN}✓ No resync/recovery in progress - array is fully synchronized${NC}"
    exit 0
fi

while true; do
    clear
    echo -e "${BLUE}=== RAID Resync Progress - $(date) ===${NC}"
    echo ""
    
    # Get fresh mdstat
    MDSTAT=$(cat /proc/mdstat)
    
    # Show mdstat
    echo "$MDSTAT"
    echo ""
    
    # Check if resync is still active
    if ! echo "$MDSTAT" | grep -A2 "md0" | grep -q "resync" && ! echo "$MDSTAT" | grep -A2 "md0" | grep -q "recovery"; then
        echo -e "${GREEN}✓ Resync completed!${NC}"
        echo -e "${GREEN}RAID array is now fully synchronized${NC}"
        break
    fi
    
    # Parse resync information
    SYNC_LINE=$(echo "$MDSTAT" | grep -A2 "md0" | grep -E "resync|recovery")
    
    if [ -n "$SYNC_LINE" ]; then
        # Extract progress percentage
        PROGRESS=$(echo "$SYNC_LINE" | grep -o 'resync = [0-9.]*%' | cut -d= -f2 | tr -d ' ' || echo "unknown")
        if [ "$PROGRESS" = "unknown" ]; then
            PROGRESS=$(echo "$SYNC_LINE" | grep -o 'recovery = [0-9.]*%' | cut -d= -f2 | tr -d ' ' || echo "unknown")
        fi
        
        # Extract remaining time
        REMAINING=$(echo "$SYNC_LINE" | grep -o 'finish=[0-9.]*min' | cut -d= -f2 || echo "unknown")
        
        # Extract speed
        SPEED=$(echo "$SYNC_LINE" | grep -o 'speed=[0-9.]*[KM]*/sec' | cut -d= -f2 || echo "unknown")
        
        # Extract blocks completed/total
        BLOCKS=$(echo "$SYNC_LINE" | grep -o 'resync = [0-9.]*% ([0-9]*/[0-9]*)' | grep -o '([0-9]*/[0-9]*)' | tr -d '()' || echo "unknown")
        if [ "$BLOCKS" = "unknown" ]; then
            BLOCKS=$(echo "$SYNC_LINE" | grep -o 'recovery = [0-9.]*% ([0-9]*/[0-9]*)' | grep -o '([0-9]*/[0-9]*)' | tr -d '()' || echo "unknown")
        fi
        
        if [ "$BLOCKS" != "unknown" ]; then
            COMPLETED_BLOCKS=$(echo "$BLOCKS" | cut -d'/' -f1)
            TOTAL_BLOCKS=$(echo "$BLOCKS" | cut -d'/' -f2)
            
            # Calculate GB completed/total (1 block = 1KB in mdstat)
            COMPLETED_GB=$((COMPLETED_BLOCKS / 1024 / 1024))
            TOTAL_GB=$((TOTAL_BLOCKS / 1024 / 1024))
            REMAINING_GB=$(( (TOTAL_BLOCKS - COMPLETED_BLOCKS) / 1024 / 1024 ))
            
            echo -e "${CYAN}Data: ${YELLOW}${COMPLETED_GB}GB / ${TOTAL_GB}GB (${REMAINING_GB}GB remaining)${NC}"
        fi
        
        # Create progress bar if we have percentage
        if [ "$PROGRESS" != "unknown" ] && [[ "$PROGRESS" =~ ^[0-9.]+%$ ]]; then
            PERCENT_NUM=$(echo "$PROGRESS" | sed 's/%//')
            BARS=$(( (${PERCENT_NUM%.*} * 40) / 100 ))
            SPACES=$(( 40 - BARS ))
            
            echo -e "${CYAN}Progress:${NC}"
            echo -ne "${GREEN}["
            for ((i=0; i<BARS; i++)); do echo -n "█"; done
            for ((i=0; i<SPACES; i++)); do echo -n "░"; done
            echo -ne "] $PROGRESS${NC}"
            echo ""
        else
            echo -e "${CYAN}Progress: ${YELLOW}$PROGRESS${NC}"
        fi
        
        echo -e "${CYAN}Estimated time remaining: ${YELLOW}${REMAINING} minutes${NC}"
        echo -e "${CYAN}Current speed: ${YELLOW}$SPEED${NC}"
        
        # Calculate estimated completion time
        if command -v date &> /dev/null && [ "$REMAINING" != "unknown" ] && [[ "$REMAINING" =~ ^[0-9.]+$ ]]; then
            REMAINING_MIN=${REMAINING%.*}
            COMPLETION_TIME=$(date -d "+${REMAINING_MIN} minutes" "+%H:%M:%S")
            echo -e "${CYAN}Estimated completion: ${YELLOW}$COMPLETION_TIME${NC}"
        fi
    else
        echo -e "${YELLOW}Could not parse resync information${NC}"
    fi
    
    echo ""
    echo -e "${CYAN}Refreshing in 10 seconds...${NC}"
    sleep 10
done
